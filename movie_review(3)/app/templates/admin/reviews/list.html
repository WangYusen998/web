{% extends "admin/base_admin.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title"><i class="fas fa-comments text-primary me-2"></i>Review Management</h1>
        <p class="page-subtitle">Manage user reviews and moderation.</p>
    </div>
</div>

<!-- Search & Filter Card -->
<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="form-group" style="flex: 2;">
            <label for="q"><i class="fas fa-search"></i> Search Content</label>
            {{ form.q(class="form-control", placeholder="Keywords...", id="q") }}
        </div>
        
        <div class="form-group">
            <label for="rating"><i class="fas fa-star"></i> Rating</label>
            {{ form.rating(class="form-control", id="rating") }}
        </div>
        
        <div class="form-group">
            <label for="date_from"><i class="far fa-calendar-alt"></i> From Date</label>
            {{ form.date_from(class="form-control", type="date", id="date_from") }}
        </div>
        
        <div class="form-group">
            <label for="date_to"><i class="far fa-calendar-alt"></i> To Date</label>
            {{ form.date_to(class="form-control", type="date", id="date_to") }}
        </div>
        
        <div class="form-group" style="flex: 0; min-width: auto;">
            <button type="submit" class="btn-action btn-secondary">
                <i class="fas fa-filter"></i> Filter
            </button>
        </div>
    </form>
</div>

<form id="batch-form" class="batch-delete-form" action="{{ url_for('admin.reviews_batch_delete') }}" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="card">
        <!-- Table Header/Toolbar -->
        <div class="table-toolbar">
            <div class="selection-info">
                <span id="selected-count" class="selection-count">0</span> reviews selected
            </div>
            <button type="submit" class="btn-action btn-danger" id="batch-delete-btn" disabled style="opacity: 0.6; cursor: not-allowed; height: 36px; padding: 0 16px; font-size: 13px;">
                <i class="fas fa-trash-alt"></i> Delete Selected
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th width="40" style="text-align: center;"><span class="sr-only">Select All</span><input type="checkbox" id="select-all" aria-label="Select all reviews" style="cursor: pointer; width: 16px; height: 16px;"></th>
                        <th width="35%">Content</th>
                        <th width="15%">Rating</th>
                        <th width="15%">Movie</th>
                        <th width="15%">User</th>
                        <th width="12%">Date</th>
                        <th width="8%" style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for review in reviews.items %}
                    <tr class="review-row">
                        <td style="text-align: center;"><input type="checkbox" name="review_ids" value="{{ review.id }}" aria-label="Select review" class="review-checkbox batch-checkbox" style="cursor: pointer; width: 16px; height: 16px;"></td>
                        <td>
                            <div class="review-content-preview" title="{{ review.content }}">
                                <a href="{{ url_for('admin.review_detail', id=review.id) }}">
                                    {{ review.content }}
                                </a>
                            </div>
                        </td>
                        <td>
                            <div class="star-rating" style="white-space: nowrap;">
                                {% for i in range(5) %}
                                    {% if i < review.rating %}
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 12px;"></i>
                                    {% else %}
                                    <i class="fas fa-star" style="color: #e9ecef; font-size: 12px;"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <a href="{{ url_for('admin.movie_edit', id=review.movie.id) }}" class="movie-link">
                                <i class="fas fa-film me-1"></i> {{ review.movie.title }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ url_for('admin.user_detail', id=review.author.id) }}" class="user-link">
                                <img src="https://ui-avatars.com/api/?name={{ review.author.username }}&background=random&color=fff&size=24" alt="" class="user-avatar-small">
                                {{ review.author.username }}
                            </a>
                        </td>
                        <td style="color: var(--text-muted); font-size: 13px;">
                            {{ review.created_at.strftime('%Y-%m-%d') }}
                        </td>
                        <td style="text-align: right;">
                            <div class="action-buttons">
                                <a href="{{ url_for('admin.review_detail', id=review.id) }}" class="btn-icon" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button type="button" class="btn-icon delete-single" title="Delete" data-url="{{ url_for('admin.review_delete', id=review.id) }}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="empty-state-container">
                            <div class="empty-state-content">
                                <div class="empty-state-icon">
                                    <i class="far fa-comments"></i>
                                </div>
                                <span style="font-size: 15px;">No reviews found matching your criteria.</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if reviews.pages > 1 %}
        <div class="pagination-container">
            {% set args = request.args.copy() %}
            {% set _ = args.pop('page', None) %}
            <ul class="pagination">
                <li class="page-item {% if not reviews.has_prev %}disabled{% endif %}">
                    <a href="{{ url_for('admin.reviews_list', page=reviews.prev_num, **args) }}" class="page-link" aria-label="Previous Page">
                        <i class="fas fa-chevron-left" aria-hidden="true"></i>
                    </a>
                </li>
                
                {% for page_num in reviews.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        {% if reviews.page == page_num %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a href="{{ url_for('admin.reviews_list', page=page_num, **args) }}" class="page-link">{{ page_num }}</a>
                        </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                <li class="page-item {% if not reviews.has_next %}disabled{% endif %}">
                    <a href="{{ url_for('admin.reviews_list', page=reviews.next_num, **args) }}" class="page-link" aria-label="Next Page">
                        <i class="fas fa-chevron-right" aria-hidden="true"></i>
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>
</form>

<!-- Hidden form for individual delete -->
<form id="delete-form" method="post" style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<script>
    // Batch Selection Logic
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.review-checkbox');
    const batchBtn = document.getElementById('batch-delete-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    
    function updateBatchBtn() {
        const checked = document.querySelectorAll('.review-checkbox:checked');
        batchBtn.disabled = checked.length === 0;
        if (selectedCountSpan) {
            selectedCountSpan.textContent = checked.length;
        }
        
        // Update batch button opacity
        if (batchBtn.disabled) {
            batchBtn.style.opacity = '0.6';
            batchBtn.style.cursor = 'not-allowed';
        } else {
            batchBtn.style.opacity = '1';
            batchBtn.style.cursor = 'pointer';
        }
    }
    
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateBatchBtn();
        });
    }
    
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateBatchBtn);
    });
    
    // Individual Delete Logic
    document.querySelectorAll('.delete-single').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this review?')) {
                const url = this.getAttribute('data-url');
                const form = document.getElementById('delete-form');
                form.action = url;
                form.submit();
            }
        });
    });
</script>
{% endblock %}
